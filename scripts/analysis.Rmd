---
title: "Calculating PDSI and SPEI"
author: "steppe"
output:
  word_document: default
always_allow_html: true
---

Variables required:

Precipitation
Available Water Content

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
```

```{r}
library(tidyverse)
library(terra)
source('functions.R')
```


Create potential solar hours rasters

"Elevation, aspect and slope input values should not be reclassified into coarser categories. This could lead to incorrect results. " - r.sun man pages

```{r Create template raster for sun hours, eval = F}

template <- rast('/hdd/Geospatial_data/sunhours/input/UFO_dem_10_smooth.tif')
xy <- ext(template)

coarse_template <- rast(nrow = 100, ncol = 100, crs = crs(template),
     xmin = xy[1], xmax =	 xy[2], ymin 	=  xy[3], ymax =  xy[4], vals = 0
       )
writeRaster(coarse_template, '/hdd/Geospatial_data/sunhours/input/coarse.tif')

rm(template, xy, coarse_template)
```


To calculate Sun hours the r.sun function from GRASS GIS was used to calculate the sun hours for across the field office for the year 2010.
```{bash calculate sun hours in GRASS GIS, eval = F}

grass --tmp-location /hdd/Geospatial_data/sunhours/input/coarse.tif
pOUT='/hdd/Geospatial_data/sunhours/output'

for i in {1..365}
do
  rasterfari=SunHours$i
  r.sunhours sunhour=$rasterfari year=2000 day=$i --overwrite
  r.out.gdal input=$rasterfari output=$pOUT/${rasterfari} format=GTiff -c --overwrite
done

r.in.gdal input=/hdd/Geospatial_data/sunhours/input/coarse.tif output=coarseDEM

for i in {1..365}
do
  rasterfari=BeamRad$i
  r.sun beam_rad=$rasterfari day=$i --overwrite nprocs=16 elevation=coarseDEM linke_value=2.325
  r.out.gdal input=$rasterfari output=$pOUT/${rasterfari} format=GTiff -c --overwrite
done

exit

```

The means of each month was taken and used as sun values across the entirety of the temporal domain.
```{r Process Sun Hour Data into Monthly Means, eval =F}

sh_p <- '/hdd/Geospatial_data/sunhours/output'

files <- data.frame(filename = list.files(sh_p, pattern = 'SunHours')) %>% 
  mutate(number = as.numeric(str_extract_all(filename,"\\(?[0-9,.]+\\)?")),
         fpath = file.path(sh_p, filename)) %>% 
  arrange(number) %>% 
  bind_cols(., 'Month' =  dmonths_normal)

mean_rasters <- files %>% 
  split(., .$Month) %>% 
  lapply(., '[[', c('fpath')) %>% 
  map(., rast) %>% 
  map(., mean)
mean_rasters <- rast(mean_rasters)

writeRaster(mean_rasters, '../data/raw/MeanSunHours.tif', overwrite = T)
file.remove(files$fpath)

# repeat the process for solar radiation. 
files <- data.frame(filename = list.files(sh_p, pattern = 'BeamRad')) %>% 
  mutate(number = as.numeric(str_extract_all(filename,"\\(?[0-9,.]+\\)?")),
         fpath = file.path(sh_p, filename)) %>% 
  arrange(number) %>% 
  bind_cols(., 'Month' =  dmonths_normal)

mean_rasters <- files %>% 
  split(., .$Month) %>% 
  lapply(., '[[', c('fpath')) %>% 
  map(., rast) %>% 
  map(., mean)
mean_rasters <- rast(mean_rasters)
mean_rasters <- mean_rasters * 0.0036 # conversion to MegaJoules, you can 
# compare your values to a kilowatt / hour map to see if you are in the range
# before you do this just do mean( mean_raster/1000 ) and is is really
# quick to find an annual map, I recommend doing it to make sure your calcs worked
# out A-OK - this stuff is way outside my wheelhouse. Ours are spot on. 

writeRaster(mean_rasters, '../data/raw/MeanRadiation.tif', overwrite = T)
file.remove(files$fpath)

rm(pancake, dmonths, sh_p, files, mean_rasters)
```

```{r Download climate vars from gridmet and subset, eval = F}

p <- '/media/reed/ExternalHD/drought_geospatial/Gridmet'
Get_Gridmet(product_type = "pr", start_year = 1979, end_year = 2021, destination = p)
Get_Gridmet(product_type = "tmmx", start_year = 1979, end_year = 2021, destination = p)
Get_Gridmet(product_type = "tmmn", start_year = 1979, end_year = 2021, destination = p)
Get_Gridmet(product_type = "vs", start_year = 1979, end_year = 2021, destination = p)
Get_Gridmet(product_type = "rmax", start_year = 1979, end_year = 2021, destination = p)
Get_Gridmet(product_type = "rmin", start_year = 1979, end_year = 2021, destination = p)
p <- file.path(p, 'Gridmet')

```


```{r reduce gridmet climate vars to monthly means, eval = F}
# now reduce the size of these data by making the monthly means
root_p <- '/media/reed/ExternalHD/drought_geospatial/Gridmet'
out_p <- '/media/reed/ExternalHD/drought_geospatial/monthly_gridmet'
crop_p <- '../data/raw/UFO_slope_deg.tif'

gridSTATS(inpath = root_p , FUN = mean,  outpath = out_p, cropRast = crop_p, variable = 'vs')
gridSTATSsum(inpath = root_p , outpath = out_p, cropRast = crop_p, variable = 'pr')
gridSTATS(inpath = root_p , FUN = mean,  outpath = out_p, cropRast = crop_p, variable = 'tmmn')
gridSTATS(inpath = root_p , FUN = mean,  outpath = out_p, cropRast = crop_p, variable = 'tmmx')
gridSTATS(inpath = root_p , FUN = mean,  outpath = out_p, cropRast = crop_p, variable = 'rmax')
gridSTATS(inpath = root_p , FUN = mean,  outpath = out_p, cropRast = crop_p, variable = 'rmin')

rmax <- rast(file.path(out_p, 'rmin', (list.files(file.path(out_p, 'rmin')))))
rmin <- rast(file.path(out_p, 'rmax', (list.files(file.path(out_p, 'rmax')))))
rhmean <- mean(rmax, rmin)
rhmean <- split(rhmean, leapYearLookUp$Year)
names(rhmean) <- unique(leapYearLookUp$Year)

ifelse(!dir.exists(file.path(out_p, 'rhmean')), 
         dir.create(file.path(out_p, 'rhmean')), FALSE)
fnames <- file.path(out_p, 'rhmean', paste0('rhmean', '_', names(rhmean), '.tif'))
mapply(writeRaster, rhmean, fnames, overwrite =T)

frm(root_p, out_p, crop_p, gridSTATS)
```

```{r Border}
border <- ext(rast('../data/raw/UFO_slope_deg.tif'))
```

```{r Crop Cloud data, eval = F}

cpath <- '/media/reed/ExternalHD/drought_geospatial/cloud'
cfiles <- file.path(cpath, list.files(cpath, pattern = "tif$"))
clouds <- rast(cfiles)

border <- project(rast('../data/raw/UFO_slope_deg.tif'), crs(clouds))
clouds <- crop(clouds, border)
template <- rast('/media/reed/ExternalHD/drought_geospatial/monthly_gridmet/vs/vs_1979.tif')[[1]]
clouds <- aggregate(clouds, fact =4)
clouds <- resample(clouds, template, method  = 'cubic')
names(clouds) <- unique(dmonths_normal)

# 0.01 the clouds values range from 0-10,000, and need be multiplied by 0.01 to recover % cover
clouds <- clouds * 0.01
plot(clouds)

writeRaster(clouds, '../data/raw/clouds.tif', NAflag=NA, overwrite = T)
rm(cpath, clouds, border, cfiles)
```


```{r subtract clouds from sun hours, eval = F}
SunHours <- rast('/media/reed/ExternalHD/UFO_drought/data/raw/MeanSunHours.tif')
SunHours <- resample(SunHours, template, method  = 'cubic')
SunHours <- SunHours[[unique(dmonths_normal)]]
SunHours <- project(SunHours, crs(template))

cloud_rasters <- 1 - (rast('../data/raw/clouds.tif') * 0.01 )  # to get a leading zero for a proportion
SunHours <- SunHours * cloud_rasters

writeRaster(SunHours, '../data/raw/MeanSunHours.tif',
            overwrite = T)
```


```{r Process and match extent for total solar radiation, eval = F}
solar_radiation <- rast('../data/raw/MeanRadiation.tif')
solar_radiation <- resample(solar_radiation, template, method  = 'cubic')
solar_radiation <- solar_radiation[[unique(dmonths_normal)]]
solar_radiation <- project(solar_radiation, crs(template))

writeRaster(solar_radiation, '../data/raw/MeanSolarRadiation.tif',
            overwrite = T)
```


```{r Crop DEM, eval = F}

dpath <- '/media/reed/ExternalHD/drought_geospatial/dem'
dem <- rast(file.path(dpath, list.files(dpath, pattern = "bil$", recursive = T)))

border <- project(rast('../data/raw/UFO_slope_deg.tif'), crs(dem))
dem <- crop(dem, border)

template <- rast('/media/reed/ExternalHD/drought_geospatial/monthly_gridmet/vs/vs_1979.tif')[[1]]
dem <- resample(dem, template, method  = 'cubic')
dem <- exactextractr::exact_resample(dem, template, "mean")

writeRaster(dem, '../data/raw/dem.tif', overwrite = T)
rm(dpath, dem)
```

SPEI calculations require a 30 year monthly means dataset to be compared to. The years 1979-2014 were used as a 35 year reference set. SPEI was then calculated for the years 2014-2021. 

```{r Calculate SPEI}
out_p <- '/media/reed/ExternalHD/drought_geospatial/monthly_gridmet'

cloudCover <- rast('../data/raw/clouds.tif')
sunHours <- rast('../data/raw/MeanSunHours.tif')
dem <- rast('../data/raw/dem.tif')
solarRadiation <- rast('../data/raw/MeanSolarRadiation.tif')

vs <- rast(file.path(out_p, 'vs', (list.files(file.path(out_p, 'vs')))))
tmax <- rast(file.path(out_p, 'tmmx', (list.files(file.path(out_p, 'tmmx')))))
tmin <- rast(file.path(out_p, 'tmmn', (list.files(file.path(out_p, 'tmmn')))))
pr <- rast(file.path(out_p, 'pr', (list.files(file.path(out_p, 'pr'))))) # rhmean.tif
rh <- rast(file.path(out_p, 'rhmean', (list.files(file.path(out_p, 'rhmean')))))

names(vs) <- namer(vs, start = 1979)
names(tmax) <- namer(tmax, start = 1979)
names(tmin) <- namer(tmin, start = 1979)
names(pr) <- namer(pr, start = 1979)
names(rh) <- namer(rh, start = 1979)
names(dem) <- 'elevation'
variables <- c(vs, tmax, tmin, rh, pr, dem)

names(cloudCover) <- paste0('cloudcover_', unique(dmonths_normal))
names(sunHours) <- paste0('sunhours_', names(sunHours))
names(solarRadiation) <- paste0('radiation_', names(solarRadiation))
suncloud <- c(cloudCover, sunHours, solarRadiation)

cloudvals <- as.data.frame(suncloud) %>% 
  rownames_to_column('CellID') %>% 
  pivot_longer(!CellID, names_to = 'combo', values_to = 'value') %>% 
  separate(combo, c('variable', 'month')) %>% 
  pivot_wider(names_from = variable, values_from = value)
drought_vars <- as.data.frame(variables, xy = T) %>% 
  rownames_to_column('CellID') %>% 
  pivot_longer(4:(ncol(.)-1)) %>% 
  separate(name, c('variable', 'month', 'year')) %>% 
  pivot_wider( names_from = variable, values_from = value) %>% 
  left_join(., cloudvals) %>% 
  mutate(across(.cols = tmax:tmin, ~.x - 273.5 ))

rm(cloudvals, suncloud, vs, tmax, tmin, variables, dem, pr, sunHours)

# drought_vars <- drought_vars[complete.cases(drought_vars),]
out <- drought_vars %>% 
  rowwise() %>% 
  split(., .$CellID) %>% 
  map(~ PeTbyCell(x = .x)) %>% 
  bind_rows() %>% 
  arrange(CellID, year) %>% 
  split(., .$CellID) %>% 
  map(~ SPEIbyCell(x = .x, start_yr = 1979, id_var = 'CellID')) %>% 
  bind_rows()

# now we will split these out so that each year x calculation duration has a stack. 
resin <- out %>% 
  pivot_longer(cols = starts_with('months'), names_to = 'period', values_to = 'SPEI') %>% 
  split(., .[,c('period','Year', 'Month')]) %>% 
  map(~ rast(template, vals = .x$SPEI))

vars <- c('months_6', 'months_12', 'months_24')
times <- leapYearLookUp %>% 
  mutate(time = paste0(Year, '.', MONTH)) %>% 
  pull(time)
vars2 <- paste0(rep(vars, each =  length(times)), '.', times)

resin <- resin[vars2]
rasta <- split(rasta, leapYearLookUp$Year)


rm(tmax, tmin, vs, variables, cloudCover, cloudvals, dem, sunHours, suncloud, 
   SunHours, pr, out_p)
```


# Calculation of SPEI 

```{r}
library(SPEI)
data(wichita)

pen <- penman(wichita$TMIN,
              wichita$TMAX,
              wichita$AWND,
              tsun=wichita$TSUN,lat=37.6475, z=402.6, na.rm=TRUE)


# Potential Evapotransrespiration,
 # requires the monthly mean temperature, and the latitudinal centroid of the cell
wichita$PET <- thornthwaite(wichita$TMED, 37.6475) 

# the total monthly precipitation minus the 
# potential evapotransrespiration is the Water Balance
wichita$BAL <- wichita$PRCP-wichita$PET 

wichita <- ts(wichita[,-c(1,2)], end=c(2011,10), frequency=12)
plot(wichita)

# Calculate the SPEI here
spei3 <- spei(wichita[,'BAL'], scale = 3) # seasonal
spei12 <- spei(wichita[,'BAL'], scale = 12) # yearly

plot(spei3)
plot(spei12)

rm(wichita)
data(wichita)

PET <- thornthwaite(wichita$TMED, 37.6475) 

# the total monthly precipitation minus the 
# potential evapotransrespiration is the Water Balance
BAL <- wichita$PRCP-PET 

wichita <- ts(wichita[,-c(1,2)], end=c(2011,10), frequency=12)
plot(wichita)

# Calculate the SPEI here
spei1 <- spei(wichita[,'BAL'], scale = 1) # one month
spei3 <- spei(wichita[,'BAL'], scale = 3) # seasonal
spei12 <- spei(wichita[,'BAL'], scale = 12) # yearly

```

