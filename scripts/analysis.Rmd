---
title: "Calculating PDSI and SPEI"
author: "steppe"
output:
  word_document: default
always_allow_html: true
---

Variables required:

Precipitation
Available Water Content

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
```

```{r}
library(tidyverse)
library(terra)
```


Create potential solar hours rasters

"Elevation, aspect and slope input values should not be reclassified into coarser categories. This could lead to incorrect results. " - r.sun man pages


```{r Create template raster for sun hours, eval = F}

template <- rast('/hdd/Geospatial_data/sunhours/input/UFO_dem_10_smooth.tif')
xy <- ext(template)

coarse_template <- rast(nrow = 100, ncol = 100, crs = crs(template),
     xmin = xy[1], xmax =	 xy[2], ymin 	=  xy[3], ymax =  xy[4], vals = 0
       )
writeRaster(coarse_template, '/hdd/Geospatial_data/sunhours/input/coarse.tif')

rm(template, xy, coarse_template)
```


To calculate Sun hours the r.sun function from GRASS GIS was used to calculate the sun hours for across the field office for the year 2010.
```{bash calculate sun hours in GRASS GIS, eval = F}

grass --tmp-location /hdd/Geospatial_data/sunhours/input/coarse.tif
pOUT='/hdd/Geospatial_data/sunhours/output'

for i in {1..365}
do
  rasterfari=SunHours$i
  r.sunhours sunhour=$rasterfari year=2000 day=$i --overwrite
  r.out.gdal input=$rasterfari output=$pOUT/${rasterfari} format=GTiff -c --overwrite
done

exit

```

The means of each month was taken and used as sun values across the entirety of the temporal domain.
```{r Process Sun Hour Data into Monthly Means, eval =F}
dmonths <- c(
  rep('JAN', length(1:31)), rep('FEB', length(32:59)), rep('MAR', length(60:90)),
  rep('APR', length(91:120)), rep('MAY', length(121:151)), rep('JUN', length(152:181)),
  rep('JUL', length(182:212)), rep('AUG', length(213:243)), rep('SEPT', length(244:273)),
  rep('OCT', length(274:304)), rep('NOV', length(305:334)), rep('DEC', length(335:365)) )
sh_p <- '/hdd/Geospatial_data/sunhours/output'

files <- data.frame(filename = list.files(sh_p)) %>% 
  mutate(number = as.numeric(str_extract_all(filename,"\\(?[0-9,.]+\\)?")),
         fpath = file.path(sh_p, filename)) %>% 
  arrange(number) %>% 
  bind_cols(., 'Month' =  dmonths)

mean_rasters <- files %>% 
  split(., .$Month) %>% 
  lapply(., '[[', c('fpath')) %>% 
  map(., rast) %>% 
  map(., mean)
mean_rasters <- rast(mean_rasters)

writeRaster(mean_rasters, '/hdd/UFO_drought/data/raw/MeanSunHours.tif', overwrite = T)
file.remove(files$fpath)

rm(pancake, dmonths, sh_p, files, mean_rasters)
```


```{r Border}
border <- ext(rast('../data/raw/UFO_slope_deg.tif'))
```

```{r Crop Cloud data, eval = F}

cpath <- '/media/sagesteppe/ExternalHD/drought_geospatial/cloud'
cfiles <- file.path(cpath, list.files(cpath, pattern = "tif$"))
clouds <- rast(cfiles)

border <- project(rast('../data/raw/UFO_slope_deg.tif'), crs(clouds))
clouds <- crop(clouds, border)

clouds

writeRaster(clouds, '../data/raw/clouds.tif', NAflag=NA, overwrite = T)
rm(cpath, clouds, border, cfiles)
```


```{r subtract clouds from sun hours}

cloud_rasters <- rast('../data/raw/clouds.tif')
max(cloud_rasters)

range(cloud_rasters)
```

```{r Crop DEM, eval = F}

dpath <- '/media/sagesteppe/ExternalHD/drought_geospatial/dem'
dem <- rast(file.path(dpath, list.files(dpath, pattern = "bil$", recursive = T)))

border <- project(rast('../data/raw/UFO_slope_deg.tif'), crs(dem))
dem <- crop(dem, border)
writeRaster(dem, '../data/raw/dem.tif', overwrite = T)

rm(dpath, dem)
```


```{r Download climate vars from gridmet and subset, eval = F}

p <- '/media/sagesteppe/ExternalHD/drought_geospatial/Gridmet'
Get_Gridmet(product_type = "pr", start_year = 1979, end_year = 2021, destination = p)
Get_Gridmet(product_type = "tmmx", start_year = 1979, end_year = 2021, destination = p)
Get_Gridmet(product_type = "tmmn", start_year = 1979, end_year = 2021, destination = p)
Get_Gridmet(product_type = "vs", start_year = 1979, end_year = 2021, destination = p)
p <- file.path(p, 'Gridmet')

# now reduce the size of these data by making the monthly means
root_p <- '/media/sagesteppe/ExternalHD/drought_geospatial/Gridmet'
out_p <- '/media/sagesteppe/ExternalHD/drought_geospatial/monthly_gridmet'
crop_p <- '../data/raw/UFO_slope_deg.tif'

gridSTATS(inpath = root_p , FUN = mean, outpath = out_p, cropRast = crop_p, variable = 'vs')
gridSTATS(inpath = root_p , FUN = mean, outpath = out_p, cropRast = crop_p, variable = 'pr')
gridSTATS(inpath = root_p , FUN = mean, outpath = out_p, cropRast = crop_p, variable = 'tmmn')
gridSTATS(inpath = root_p , FUN = mean, outpath = out_p, cropRast = crop_p, variable = 'tmmx')

rm(root_p, out_p, crop_p, gridSTATS)
```



# Calculation of SPEI 
```{r}
library(SPEI)

data(wichita)

# Potential Evapotransrespiration,
 # requires the monthly mean temperature, and the latitudinal centroid of the cell
wichita$PET <- thornthwaite(wichita$TMED, 37.6475) 

# the total monthly precipitation minus the 
# potential evapotransrespiration is the Water Balance
wichita$BAL <- wichita$PRCP-wichita$PET 

wichita <- ts(wichita[,-c(1,2)], end=c(2011,10), frequency=12)
plot(wichita)

# Calculate the SPEI here
spei3 <- spei(wichita[,'BAL'], scale = 3) # seasonal
spei12 <- spei(wichita[,'BAL'], scale = 12) # yearly

plot(spei3)
plot(spei12)

rm(wichita)
data(wichita)

PET <- thornthwaite(wichita$TMED, 37.6475) 

# the total monthly precipitation minus the 
# potential evapotransrespiration is the Water Balance
BAL <- wichita$PRCP-PET 

wichita <- ts(wichita[,-c(1,2)], end=c(2011,10), frequency=12)
plot(wichita)

# Calculate the SPEI here
spei1 <- spei(wichita[,'BAL'], scale = 1) # one month
spei3 <- spei(wichita[,'BAL'], scale = 3) # seasonal
spei12 <- spei(wichita[,'BAL'], scale = 12) # yearly

```

